<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDDå…ƒæ•°æ®é©±åŠ¨å¼€å‘å¹³å° - æ¨¡å—åŒ–ç‰ˆæœ¬</title>
    
    <!-- æ ¸å¿ƒCSS -->
    <link rel="stylesheet" href="https://unpkg.com/amis@6.3.0/lib/themes/antd.css" />
    <link rel="stylesheet" href="./src/css/main.css" />
    
    <!-- ç¬¬ä¸‰æ–¹ä¾èµ– -->
    <script src="https://unpkg.com/amis@6.3.0/lib/sdk.js"></script>
    
    <style>
        /* åŸºç¡€é‡ç½®å’ŒåŠ è½½çŠ¶æ€ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 16px;
            color: #666;
            font-size: 14px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">DDDå¹³å°åŠ è½½ä¸­...</div>
    </div>
    
    <!-- åº”ç”¨å®¹å™¨ -->
    <div id="app" class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="toolbar-main">
                <div class="toolbar-header">
                    <h3>ğŸ¯ DDDå¹³å°</h3>
                    <div class="toolbar-actions">
                        <button class="toolbar-btn" onclick="dddEditor.newSchema()" title="æ–°å»ºé¡¹ç›®">
                            ğŸ“
                        </button>
                        <button class="toolbar-btn" onclick="dddEditor.saveSchema()" title="ä¿å­˜é¡¹ç›® (Ctrl+S)">
                            ğŸ’¾
                        </button>
                        <button class="toolbar-btn" onclick="dddEditor.importSchema()" title="å¯¼å…¥Schema">
                            ğŸ“‚
                        </button>
                        <button class="toolbar-btn" onclick="dddEditor.previewCode()" title="é¢„è§ˆä»£ç ">
                            ğŸ‘€
                        </button>
                    </div>
                </div>
                
                <!-- ç»„ä»¶å·¥å…·æ  -->
                <div class="component-toolbar-main">
                    <!-- åŠ¨æ€åŠ è½½ç»„ä»¶åˆ—è¡¨ -->
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- é¡¶éƒ¨æ“ä½œæ  -->
            <div class="top-toolbar">
                <div class="left-actions">
                    <button class="action-btn primary" onclick="dddEditor.validateSchema()">
                        âœ… éªŒè¯Schema
                    </button>
                    <button class="action-btn" onclick="dddEditor.previewCode()">
                        ğŸ” ä»£ç é¢„è§ˆ
                    </button>
                </div>
                
                <div class="center-info">
                    <span id="status-text" class="status-text">å°±ç»ª</span>
                </div>
                
                <div class="right-actions">
                    <button class="action-btn" onclick="toggleFullscreen()">
                        ğŸ”³ å…¨å±
                    </button>
                    <button class="action-btn" onclick="showHelp()">
                        â“ å¸®åŠ©
                    </button>
                </div>
            </div>
            
            <!-- ç”»å¸ƒåŒºåŸŸ -->
            <div class="canvas-container">
                <div id="canvas" class="canvas">
                    <!-- AMISç»„ä»¶æ¸²æŸ“åŒºåŸŸ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±€æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modal-container"></div>
    
    <!-- çŠ¶æ€æç¤ºå®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- è„šæœ¬åŠ è½½ -->
    <script>
        // å…¨å±€é…ç½®
        window.DDD_CONFIG = {
            version: '1.0.0',
            debug: true,
            apiBase: '/api',
            autoSave: true,
            autoSaveInterval: 30000 // 30ç§’è‡ªåŠ¨ä¿å­˜
        };
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.onerror = function(msg, url, line, col, error) {
            console.error('å…¨å±€é”™è¯¯:', {
                message: msg,
                source: url,
                line: line,
                column: col,
                error: error
            });
            
            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            if (window.DDDEditorUtils) {
                window.DDDEditorUtils.showStatus('åº”ç”¨é‡åˆ°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
            
            return false;
        };
        
        // Promiseé”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
            if (window.DDDEditorUtils) {
                window.DDDEditorUtils.showStatus('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });
        
        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // æ˜¾ç¤ºå¸®åŠ©
        function showHelp() {
            if (window.DDDEditorUtils) {
                window.DDDEditorUtils.showModal('å¸®åŠ©æ–‡æ¡£', `
                    <div style="line-height: 1.6;">
                        <h4>ğŸš€ å¿«é€Ÿå¼€å§‹</h4>
                        <ul>
                            <li>ä»å·¦ä¾§å·¥å…·æ æ‹–æ‹½ç»„ä»¶åˆ°ç”»å¸ƒ</li>
                            <li>ç‚¹å‡»ç»„ä»¶è¿›è¡Œç¼–è¾‘å’Œé…ç½®</li>
                            <li>ä½¿ç”¨Ctrl+Sä¿å­˜é¡¹ç›®</li>
                        </ul>
                        
                        <h4>âŒ¨ï¸ å¿«æ·é”®</h4>
                        <ul>
                            <li><kbd>Ctrl+S</kbd> - ä¿å­˜é¡¹ç›®</li>
                            <li><kbd>Ctrl+N</kbd> - æ–°å»ºé¡¹ç›®</li>
                            <li><kbd>Ctrl+Z</kbd> - æ’¤é”€</li>
                            <li><kbd>Ctrl+Shift+Z</kbd> - é‡åš</li>
                        </ul>
                        
                        <h4>ğŸ”§ DDDç»„ä»¶</h4>
                        <ul>
                            <li><strong>å®ä½“</strong> - é¢†åŸŸæ ¸å¿ƒå¯¹è±¡</li>
                            <li><strong>èšåˆ</strong> - ä¸šåŠ¡ä¸€è‡´æ€§è¾¹ç•Œ</li>
                            <li><strong>æœåŠ¡</strong> - ä¸šåŠ¡é€»è¾‘å¤„ç†</li>
                            <li><strong>ä»“å‚¨</strong> - æ•°æ®è®¿é—®æŠ½è±¡</li>
                            <li><strong>å€¼å¯¹è±¡</strong> - ä¸å¯å˜å€¼ç±»å‹</li>
                        </ul>
                    </div>
                `);
            }
        }
        
        // åº”ç”¨åˆå§‹åŒ–
        async function initializeApp() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
                
                // ç­‰å¾…AMISåŠ è½½å®Œæˆ
                let retryCount = 0;
                const maxRetries = 10;
                
                while (typeof amis === 'undefined' && retryCount < maxRetries) {
                    console.log(`ç­‰å¾…AMISåŠ è½½... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retryCount++;
                }
                
                if (typeof amis === 'undefined') {
                    throw new Error('AMISæ¡†æ¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CDNçŠ¶æ€');
                }
                
                console.log('AMISæ¡†æ¶åŠ è½½æˆåŠŸ');
                
                // åŠ è½½å·¥å…·æ¨¡å—
                try {
                    await loadModule('./src/utils/utils.js');
                    console.log('å·¥å…·æ¨¡å—åŠ è½½æˆåŠŸ');
                } catch (error) {
                    console.warn('å·¥å…·æ¨¡å—åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®å®ç°:', error);
                    // æä¾›åŸºæœ¬çš„å·¥å…·å‡½æ•°
                    window.DDD_Utils = {
                        showStatus: function(message, type = 'info') {
                            console.log(`[${type.toUpperCase()}] ${message}`);
                            
                            // ç®€å•çš„çŠ¶æ€æ˜¾ç¤º
                            const statusDiv = document.getElementById('status') || document.createElement('div');
                            statusDiv.id = 'status';
                            statusDiv.style.position = 'fixed';
                            statusDiv.style.top = '20px';
                            statusDiv.style.right = '20px';
                            statusDiv.style.padding = '8px 16px';
                            statusDiv.style.borderRadius = '4px';
                            statusDiv.style.zIndex = '10000';
                            statusDiv.style.color = 'white';
                            statusDiv.style.backgroundColor = type === 'error' ? '#ff4d4f' : type === 'success' ? '#52c41a' : '#1890ff';
                            statusDiv.textContent = message;
                            
                            document.body.appendChild(statusDiv);
                            
                            setTimeout(() => {
                                if (statusDiv.parentNode) {
                                    statusDiv.parentNode.removeChild(statusDiv);
                                }
                            }, 3000);
                        }
                    };
                }
                
                // åŠ è½½ç»„ä»¶æ¨¡å—
                try {
                    await loadModule('./src/components/templates.js');
                    console.log('ç»„ä»¶æ¨¡æ¿åŠ è½½æˆåŠŸ');
                } catch (error) {
                    console.warn('ç»„ä»¶æ¨¡æ¿åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬:', error);
                    // æä¾›åŸºæœ¬çš„ç»„ä»¶æ¨¡æ¿
                    window.DDD_Templates = {
                        getComponentTemplate: function(type) {
                            const basicTemplates = {
                                entity: {
                                    type: 'card',
                                    header: { title: 'å®ä½“ - Entity', subTitle: 'DDDæ ¸å¿ƒä¸šåŠ¡å¯¹è±¡' },
                                    body: {
                                        type: 'form',
                                        mode: 'horizontal',
                                        body: [
                                            { type: 'input-text', name: 'name', label: 'å®ä½“åç§°', required: true },
                                            { type: 'textarea', name: 'description', label: 'å®ä½“æè¿°', rows: 3 }
                                        ]
                                    }
                                },
                                form: {
                                    type: 'form',
                                    title: 'è¡¨å•',
                                    body: [
                                        { type: 'input-text', name: 'name', label: 'åç§°', required: true }
                                    ]
                                }
                            };
                            return basicTemplates[type] || basicTemplates.form;
                        }
                    };
                }
                
                // åŠ è½½é€‰æ‹©å™¨æ¨¡å—
                try {
                    await loadModule('./src/components/selectors-fixed.js');
                    console.log('é€‰æ‹©å™¨æ¨¡å—åŠ è½½æˆåŠŸ');
                } catch (error) {
                    console.warn('é€‰æ‹©å™¨æ¨¡å—åŠ è½½å¤±è´¥ï¼Œç¦ç”¨é€‰æ‹©å™¨åŠŸèƒ½:', error);
                }
                
                // åŠ è½½ç¼–è¾‘å™¨æ¨¡å—
                try {
                    await loadModule('./src/js/editor.js');
                    console.log('ç¼–è¾‘å™¨æ¨¡å—åŠ è½½æˆåŠŸ');
                } catch (error) {
                    console.warn('ç¼–è¾‘å™¨æ¨¡å—åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–ç¼–è¾‘å™¨:', error);
                    // åˆ›å»ºç®€åŒ–ç¼–è¾‘å™¨
                    window.dddEditor = {
                        isInitialized: false,
                        currentSchema: {
                            type: 'page',
                            title: 'DDDå¹³å° - ç®€åŒ–æ¨¡å¼',
                            body: []
                        },
                        
                        async init() {
                            this.isInitialized = true;
                            this.render();
                            return true;
                        },
                        
                        render() {
                            const container = document.getElementById('editor-container');
                            if (container && window.amis) {
                                try {
                                    window.amisInstance = amis.embed(container, this.currentSchema);
                                    console.log('AMISå®ä¾‹åˆ›å»ºæˆåŠŸ');
                                } catch (error) {
                                    console.error('AMISæ¸²æŸ“å¤±è´¥:', error);
                                    container.innerHTML = `
                                        <div style="padding: 20px; text-align: center;">
                                            <h3>ç¼–è¾‘å™¨åŠ è½½å¤±è´¥</h3>
                                            <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                                            <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
                                        </div>
                                    `;
                                }
                            }
                        },
                        
                        getCurrentSchema() {
                            return this.currentSchema;
                        },
                        
                        addComponent(type) {
                            const template = window.DDD_Templates ? 
                                window.DDD_Templates.getComponentTemplate(type) : 
                                { type: 'tpl', tpl: `æ–°å¢${type}ç»„ä»¶` };
                            
                            this.currentSchema.body = this.currentSchema.body || [];
                            this.currentSchema.body.push(template);
                            this.render();
                            
                            if (window.DDD_Utils) {
                                window.DDD_Utils.showStatus(`å·²æ·»åŠ ${type}ç»„ä»¶`, 'success');
                            }
                        }
                    };
                }
                
                // åˆå§‹åŒ–ç¼–è¾‘å™¨
                if (window.dddEditor) {
                    console.log('åˆå§‹åŒ–ç¼–è¾‘å™¨...');
                    await window.dddEditor.init();
                    console.log('ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ');
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                    }
                    
                    // åˆå§‹åŒ–ç»„ä»¶å·¥å…·æ 
                    initializeBasicToolbar();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (window.DDD_Utils) {
                        window.DDD_Utils.showStatus('DDDå¹³å°åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                    }
                    
                } else {
                    throw new Error('DDDç¼–è¾‘å™¨åˆ›å»ºå¤±è´¥');
                }
                
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.innerHTML = `
                        <div style="text-align: center; color: #ff4d4f;">
                            <h3>âŒ åˆå§‹åŒ–å¤±è´¥</h3>
                            <p style="margin: 16px 0;">${error.message}</p>
                            <button onclick="location.reload()" 
                                style="padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                é‡æ–°åŠ è½½
                            </button>
                            <p style="margin-top: 16px; font-size: 12px; color: #999;">
                                å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•ä½¿ç”¨ <a href="./simple.html" style="color: #1890ff;">å•æ–‡ä»¶ç‰ˆæœ¬</a>
                            </p>
                        </div>
                    `;
                }
            }
        }

        // åˆå§‹åŒ–åŸºç¡€å·¥å…·æ 
        function initializeBasicToolbar() {
            const toolbar = document.querySelector('.component-toolbar-main');
            if (!toolbar) return;
            
            const components = [
                { type: 'entity', label: 'å®ä½“', icon: 'ğŸ—ï¸' },
                { type: 'form', label: 'è¡¨å•', icon: 'ğŸ“' },
                { type: 'table', label: 'è¡¨æ ¼', icon: 'ğŸ“‹' }
            ];
            
            const toolbarHTML = components.map(comp => `
                <button class="component-btn" onclick="window.dddEditor && window.dddEditor.addComponent('${comp.type}')" 
                    style="display: block; width: 100%; margin-bottom: 8px; padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; text-align: left;">
                    ${comp.icon} ${comp.label}
                </button>
            `).join('');
            
            toolbar.innerHTML = toolbarHTML;
        }
                                    style="padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px;">
                                ğŸ”„ é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // åŠ¨æ€åŠ è½½æ¨¡å—
        function loadModule(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`æ— æ³•åŠ è½½æ¨¡å—: ${src}`));
                document.head.appendChild(script);
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // é¡µé¢å¸è½½å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', function(e) {
            if (window.dddEditor && window.dddEditor.isInitialized) {
                // è¿™é‡Œå¯ä»¥å®ç°æœªä¿å­˜æ›´æ”¹çš„æé†’
                const hasUnsavedChanges = false; // å®é™…åº”ç”¨ä¸­éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
                
                if (hasUnsavedChanges) {
                    const message = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                    e.returnValue = message;
                    return message;
                }
            }
        });
    </script>
</body>
</html>
