import{f as M,bz as C,d as Q,g as W,D as X,r as u,b9 as j,eu as Z,eK as $,aA as D,ao as ee,ay as z,az as O,_ as te,o as N,c as oe,k as c,w as l,m as L,I as ie,q as ae,F as se,N as re,cf as ne,P as ue,R as ce}from"./index-BaY5TDP-.js";import{_ as le}from"./Dialog-CZSXtzfQ.js";import{_ as de}from"./Form-CB5RGX1K.js";import pe from"./SpuSelect-egfD7fzC.js";import me from"./SpuAndSkuList-BPESFKMK.js";import{b as q}from"./formatTime-Dr6TiYYc.js";import{r as T}from"./formRules-CMjZInfO.js";import{u as fe}from"./useCrudSchemas-BQxlWSsn.js";import{b as ge}from"./spu-BVX48OKx.js";import{g as ve}from"./index-DqlyDc99.js";import{i as K}from"./constants-CEEr2azc.js";const ye=M({name:[T],startTime:[T],endTime:[T],discountType:[T]}),Pe=M([{label:"\u6D3B\u52A8\u540D\u79F0",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:q,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:q,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u5546\u54C1",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"\u5907\u6CE8",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:he}=fe(Pe),Se=async m=>await C.get({url:"/promotion/discount-activity/page",params:m}),Ce=async m=>await C.put({url:"/promotion/discount-activity/close?id="+m}),be=async m=>await C.delete({url:"/promotion/discount-activity/delete?id="+m}),B=te(Q({name:"PromotionDiscountActivityForm",__name:"DiscountActivityForm",emits:["success"],setup(m,{expose:a,emit:R}){const{t}=W(),b=X(),k=u(!1),g=u(""),d=u(!1),v=u(""),p=u(),V=u(),_=u(),o=u([]),n=u([]),y=u([]),I=async(e,i,s,f)=>{var U;if(y.value.includes(e))return void(f!=="load"&&b.error("\u6570\u636E\u91CD\u590D\u9009\u62E9\uFF01"));y.value.push(e);const P=await ge([e]);if(P.length==0)return;const r=P[0],h=i===void 0?r==null?void 0:r.skus:(U=r==null?void 0:r.skus)==null?void 0:U.filter(w=>i.includes(w.id));h==null||h.forEach(w=>{let F={skuId:w.id,spuId:r.id,discountType:1,discountPercent:0,discountPrice:0};if(s!==void 0){const S=s.find(J=>J.skuId===w.id);S&&(S.discountPercent=D(S.discountPercent),S.discountPrice=D(S.discountPrice)),F=S||F}w.productConfig=F}),r.skus=h,n.value.push({spuId:r.id,spuDetail:r,propertyList:ve(r)}),o.value.push(r)},x=async(e,i)=>{var s;if(k.value=!0,g.value=t("action."+e),v.value=e,await A(),i){d.value=!0;try{const f=await(async P=>await C.get({url:"/promotion/discount-activity/get?id="+P}))(i);for(let P in f.products){const r=f.products[P].spuId;await I(r,(s=f.products)==null?void 0:s.map(h=>h.skuId),f.products,"load")}p.value.setValues(f)}finally{d.value=!1}}};a({open:x});const Y=R,G=j(e=>{e.productConfig.discountPrice<=0||(e.productConfig.discountType=K.PRICE.type,e.productConfig.discountPercent=Z(e.price-$(e.productConfig.discountPrice),e.price))},200),H=j(e=>{e.productConfig.discountPercent<=0||e.productConfig.discountPercent>=100||(e.productConfig.discountType=K.PERCENT.type,e.productConfig.discountPrice=D(e.price-e.price*(e.productConfig.discountPercent/100||0)))},200),A=async()=>{o.value=[],n.value=[],y.value=[],await ee(),p.value.getElFormRef().resetFields()},E={t,message:b,dialogVisible:k,dialogTitle:g,formLoading:d,formType:v,formRef:p,spuSelectRef:V,spuAndSkuListRef:_,ruleConfig:[{name:"productConfig.discountPrice",rule:e=>e>0,message:"\u5546\u54C1\u4F18\u60E0\u91D1\u989D\u4E0D\u80FD\u4E3A 0 \uFF01\uFF01\uFF01"}],spuList:o,spuPropertyList:n,spuIds:y,selectSpu:(e,i)=>{I(e,i)},getSpuDetails:I,open:x,emit:Y,submitForm:async()=>{if(p&&await p.value.getElFormRef().validate()){d.value=!0;try{const e=z(_.value.getSkuConfigs("productConfig"));e.forEach(s=>{s.discountPercent=O(s.discountPercent),s.discountPrice=O(s.discountPrice)});const i=z(p.value.formModel);i.products=e,v.value==="create"?(await(async s=>await C.post({url:"/promotion/discount-activity/create",data:s}))(i),b.success(t("common.createSuccess"))):(await(async s=>await C.put({url:"/promotion/discount-activity/update",data:s}))(i),b.success(t("common.updateSuccess"))),k.value=!1,Y("success")}finally{d.value=!1}}},handleSkuDiscountPriceChange:G,handleSkuDiscountPercentChange:H,resetForm:A,deleteSpu:e=>{y.value.splice(y.value.findIndex(i=>i==e),1),n.value.splice(n.value.findIndex(i=>i.spuId==e),1)},get SpuAndSkuList(){return me},get SpuSelect(){return pe},get allSchemas(){return he},get rules(){return ye},get fenToYuan(){return D}};return Object.defineProperty(E,"__isScriptSetup",{enumerable:!1,value:!0}),E}}),[["render",function(m,a,R,t,b,k){const g=re,d=ne,v=ue,p=de,V=le,_=ce;return N(),oe(se,null,[c(V,{modelValue:t.dialogVisible,"onUpdate:modelValue":a[2]||(a[2]=o=>t.dialogVisible=o),title:t.dialogTitle,width:"65%"},{footer:l(()=>[c(g,{disabled:t.formLoading,type:"primary",onClick:t.submitForm},{default:l(()=>a[4]||(a[4]=[L("\u786E \u5B9A")])),_:1},8,["disabled"]),c(g,{onClick:a[1]||(a[1]=o=>t.dialogVisible=!1)},{default:l(()=>a[5]||(a[5]=[L("\u53D6 \u6D88")])),_:1})]),default:l(()=>[ie((N(),ae(p,{ref:"formRef",isCol:!0,rules:t.rules,schema:t.allSchemas.formSchema},{spuId:l(()=>[c(g,{onClick:a[0]||(a[0]=o=>t.spuSelectRef.open())},{default:l(()=>a[3]||(a[3]=[L("\u9009\u62E9\u5546\u54C1")])),_:1}),c(t.SpuAndSkuList,{ref:"spuAndSkuListRef",deletable:!0,"rule-config":t.ruleConfig,"spu-list":t.spuList,"spu-property-list-p":t.spuPropertyList,onDelete:t.deleteSpu},{default:l(()=>[c(v,{align:"center",label:"\u4F18\u60E0\u91D1\u989D","min-width":"168"},{default:l(({row:o})=>[c(d,{modelValue:o.productConfig.discountPrice,"onUpdate:modelValue":n=>o.productConfig.discountPrice=n,max:parseFloat(t.fenToYuan(o.price)),min:0,precision:2,step:.1,class:"w-100%",onChange:n=>t.handleSkuDiscountPriceChange(o)},null,8,["modelValue","onUpdate:modelValue","max","onChange"])]),_:1}),c(v,{align:"center",label:"\u6298\u6263\u767E\u5206\u6BD4(%)","min-width":"168"},{default:l(({row:o})=>[c(d,{modelValue:o.productConfig.discountPercent,"onUpdate:modelValue":n=>o.productConfig.discountPercent=n,max:100,min:0,precision:2,step:.1,class:"w-100%",onChange:n=>t.handleSkuDiscountPercentChange(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[_,t.formLoading]])]),_:1},8,["modelValue","title"]),c(t.SpuSelect,{ref:"spuSelectRef",isSelectSku:!0,onConfirm:t.selectSpu},null,512)],64)}],["__file","/Users/steven/00/500_code/520_github/yudao-ui-admin-vue3/src/views/mall/promotion/discountActivity/DiscountActivityForm.vue"]]),we=Object.freeze(Object.defineProperty({__proto__:null,default:B},Symbol.toStringTag,{value:"Module"}));export{B as D,we as a,Ce as c,be as d,Se as g};
