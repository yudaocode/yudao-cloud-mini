import{bz as R,ds as W,d as Z,cv as O,r as h,D as Q,f as ee,b as j,eL as se,aI as D,b9 as te,a as P,ao as ae,_ as ne,am as re,X as oe,o as c,q as I,w as f,k as u,j as K,t as H,c as N,F as le,n as ie,ah as E,a2 as V,I as Y,ag as ue,Y as ce,a_ as me,b6 as de,aq as pe,z as fe,e8 as ge,Z as ve,eg as ye,b7 as he}from"./index-BaY5TDP-.js";import{E as Me}from"./el-empty-wTPt5q4m.js";import{E as Te}from"./el-image-Bg-CwbDE.js";import{E as we}from"./el-avatar-DZsRbb7z.js";import Ee from"./EmojiSelectPopover-DCYXKLfh.js";import xe from"./PictureSelectUpload-CsCtadzn.js";import ke from"./ProductItem-B-fB2q4x.js";import Se from"./OrderItem-DNgvh09i.js";import{u as Ce}from"./emoji-D4-VYurZ.js";import{u as _e,K as A}from"./kefu-CpQb7Flh.js";import{U as be}from"./constants-CEEr2azc.js";import{f as z}from"./formatTime-Dr6TiYYc.js";import"./picture-CTjip5lJ.js";const Ie=async m=>await R.post({url:"/promotion/kefu-message/send",data:m}),Ke=async m=>await R.put({url:"/promotion/kefu-message/update-read-status?conversationId="+m}),Le=async m=>await R.get({url:"/promotion/kefu-message/list",params:m});var Ue={exports:{}};const Ne=W(Ue.exports=function(m,x,d){m=m||{};var e=x.prototype,L={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function o(a,n,g,M){return e.fromToBase(a,n,g,M)}d.en.relativeTime=L,e.fromToBase=function(a,n,g,M,T){for(var k,v,w,S=g.$locale().relativeTime||L,p=m.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],U=p.length,s=0;s<U;s+=1){var i=p[s];i.d&&(k=M?d(a).diff(g,i.d,!0):g.diff(a,i.d,!0));var y=(m.rounding||Math.round)(Math.abs(k));if(w=k>0,y<=i.r||!i.r){y<=1&&s>0&&(i=p[s-1]);var C=S[i.l];T&&(y=T(""+y)),v=typeof C=="string"?C.replace("%d",y):C(y,n,i.l,w);break}}if(n)return v;var _=w?S.future:S.past;return typeof _=="function"?_(v):_.replace("%s",v)},e.to=function(a,n){return o(a,n,this,!0)},e.from=function(a,n){return o(a,n,this)};var l=function(a){return a.$u?d.utc():d()};e.toNow=function(a){return this.to(l(this),a)},e.fromNow=function(a){return this.from(l(this),a)}}),Fe={class:"kefu-title"},je={key:0,ref:"innerRef",class:"w-[100%] px-10px"},Pe={class:"flex justify-center items-center mb-20px"},Re={key:0,class:"date-message"},Oe={key:1,class:"system-message"},De={key:0,class:"line-height-normal text-justify h-1/1 w-full"},He={class:"chat-tools flex items-center"},Ae=ne(Z({name:"KeFuMessageList",__name:"KeFuMessageList",setup(m,{expose:x}){O.extend(Ne);const d=h(""),{replaceEmoji:e}=Ce(),L=Q(),o=h([]),l=h({}),a=h(!1),n=ee({conversationId:0,createTime:void 0}),g=h(0),M=h(!1),T=_e(),k=j(()=>t=>se(t.content)),v=async()=>{const t=await Le(n);if(D(t))i.value=!0;else{if(n.createTime=z(t.at(-1).createTime),n.createTime)for(const r of t)w(r);else o.value=t;M.value=!0}},w=t=>{o.value.some(r=>r.id===t.id)||o.value.push(t)},S=j(()=>(o.value.sort((t,r)=>t.createTime-r.createTime),o.value)),p=async t=>{if(l.value){if(t!==void 0){if(t.conversationId!==l.value.id)return;w(t)}else n.createTime=void 0,await v();b.value?a.value=!0:await X()}},U=async t=>{T.saveMessageList(l.value.id,o.value),o.value=T.getConversationMessageList(t.id)||[],g.value=o.value.length||0,b.value=!1,M.value=!1,i.value=!1,l.value=t,n.conversationId=t.id,n.createTime=void 0,await p()};x({getNewMessageList:U,refreshMessageList:p});const s=j(()=>!D(l.value)),i=h(!1),y=async t=>{await Ie(t),d.value="",await p(),await T.updateConversation(l.value.id)},C=h(),_=h(),B=async()=>{b.value||(await ae(),_.value.setScrollTop(C.value.clientHeight),a.value=!1,await Ke(l.value.id))},X=async()=>{b.value=!1,await B()},b=h(!1),J=te(({scrollTop:t})=>{var F;if(i.value)return;Math.floor(t)===0&&G();const r=(F=_.value)==null?void 0:F.wrapRef;Math.abs(r.scrollHeight-r.clientHeight-r.scrollTop)<1&&(b.value=!1,p())},200),G=async()=>{var r;const t=(r=C.value)==null?void 0:r.clientHeight;t&&(b.value=!0,await v(),_.value.setScrollTop(C.value.clientHeight-t))},$=j(()=>(t,r)=>P(o.value)[r+1]?O(P(o.value)[r+1].createTime).fromNow()!==O(P(t).createTime).fromNow():!1),q={message:d,replaceEmoji:e,messageTool:L,messageList:o,conversation:l,showNewMessageTip:a,queryParams:n,total:g,refreshContent:M,kefuStore:T,getMessageContent:k,getMessageList:v,pushMessage:w,getMessageList0:S,refreshMessageList:p,getNewMessageList:U,showKeFuMessageList:s,skipGetMessageList:i,handleEmojiSelect:t=>{d.value+=t.name},handleSendPicture:async t=>{const r={conversationId:l.value.id,contentType:A.IMAGE,content:JSON.stringify({picUrl:t})};await y(r)},handleSendMessage:async t=>{var F;if(t.shiftKey)return;if(D((F=P(d.value))==null?void 0:F.trim()))return L.notifyWarning("\u8BF7\u8F93\u5165\u6D88\u606F\u540E\u518D\u53D1\u9001\u54E6\uFF01"),void(d.value="");const r={conversationId:l.value.id,contentType:A.TEXT,content:JSON.stringify({text:d.value})};await y(r)},sendMessage:y,innerRef:C,scrollbarRef:_,scrollToBottom:B,handleToNewMessage:X,loadHistory:b,handleScroll:J,handleOldMessage:G,showTime:$,EmojiSelectPopover:Ee,PictureSelectUpload:xe,ProductItem:ke,OrderItem:Se,get KeFuMessageContentTypeEnum(){return A},get UserTypeEnum(){return be},get formatDate(){return z}};return Object.defineProperty(q,"__isScriptSetup",{enumerable:!1,value:!0}),q}}),[["render",function(m,x,d,e,L,o){const l=de,a=we,n=re("MessageItem"),g=Te,M=pe,T=fe,k=ge,v=ve,w=ye,S=he,p=Me,U=oe("dompurify-html");return e.showKeFuMessageList?(c(),I(S,{key:0,class:"kefu"},{default:f(()=>[u(l,{class:"kefu-header"},{default:f(()=>[K("div",Fe,H(e.conversation.userNickname),1)]),_:1}),u(k,{class:"kefu-content overflow-visible"},{default:f(()=>[u(M,{ref:"scrollbarRef",always:"",onScroll:e.handleScroll},{default:f(()=>[e.refreshContent?(c(),N("div",je,[(c(!0),N(le,null,ie(e.getMessageList0,(s,i)=>(c(),N("div",{key:s.id,class:"w-[100%]"},[K("div",Pe,[s.contentType!==e.KeFuMessageContentTypeEnum.SYSTEM&&e.showTime(s,i)?(c(),N("div",Re,H(e.formatDate(s.createTime)),1)):E("",!0),s.contentType===e.KeFuMessageContentTypeEnum.SYSTEM?(c(),N("div",Oe,H(s.content),1)):E("",!0)]),K("div",{class:V([[s.senderType===e.UserTypeEnum.MEMBER?"ss-row-left":s.senderType===e.UserTypeEnum.ADMIN?"ss-row-right":""],"flex mb-20px w-[100%]"])},[s.senderType===e.UserTypeEnum.MEMBER?(c(),I(a,{key:0,src:e.conversation.userAvatar,alt:"avatar",class:"w-60px h-60px"},null,8,["src"])):E("",!0),K("div",{class:V({"kefu-message":e.KeFuMessageContentTypeEnum.TEXT===s.contentType})},[u(n,{message:s},{default:f(()=>[e.KeFuMessageContentTypeEnum.TEXT===s.contentType?Y((c(),N("div",De,null,512)),[[U,e.replaceEmoji(e.getMessageContent(s).text||s.content)]]):E("",!0)]),_:2},1032,["message"]),u(n,{message:s},{default:f(()=>[e.KeFuMessageContentTypeEnum.IMAGE===s.contentType?(c(),I(g,{key:0,"initial-index":0,"preview-src-list":[e.getMessageContent(s).picUrl||s.content],src:e.getMessageContent(s).picUrl||s.content,class:"w-200px mx-10px",fit:"contain","preview-teleported":""},null,8,["preview-src-list","src"])):E("",!0)]),_:2},1032,["message"]),u(n,{message:s},{default:f(()=>[e.KeFuMessageContentTypeEnum.PRODUCT===s.contentType?(c(),I(e.ProductItem,{key:0,picUrl:e.getMessageContent(s).picUrl,price:e.getMessageContent(s).price,"sales-count":e.getMessageContent(s).salesCount,spuId:e.getMessageContent(s).spuId,stock:e.getMessageContent(s).stock,title:e.getMessageContent(s).spuName,class:"max-w-300px mx-10px"},null,8,["picUrl","price","sales-count","spuId","stock","title"])):E("",!0)]),_:2},1032,["message"]),u(n,{message:s},{default:f(()=>[e.KeFuMessageContentTypeEnum.ORDER===s.contentType?(c(),I(e.OrderItem,{key:0,message:s,class:"max-w-100% mx-10px"},null,8,["message"])):E("",!0)]),_:2},1032,["message"])],2),s.senderType===e.UserTypeEnum.ADMIN?(c(),I(a,{key:1,src:s.senderAvatar,alt:"avatar"},null,8,["src"])):E("",!0)],2)]))),128))],512)):E("",!0)]),_:1},8,["onScroll"]),Y(K("div",{class:"newMessageTip flex items-center cursor-pointer",onClick:e.handleToNewMessage},[x[1]||(x[1]=K("span",null,"\u6709\u65B0\u6D88\u606F",-1)),u(T,{class:"ml-5px",icon:"ep:bottom"})],512),[[ue,e.showNewMessageTip]])]),_:1}),u(w,{class:"kefu-footer"},{default:f(()=>[K("div",He,[u(e.EmojiSelectPopover,{onSelectEmoji:e.handleEmojiSelect}),u(e.PictureSelectUpload,{class:"ml-15px mt-3px cursor-pointer",onSendPicture:e.handleSendPicture})]),u(v,{modelValue:e.message,"onUpdate:modelValue":x[0]||(x[0]=s=>e.message=s),rows:6,placeholder:"\u8F93\u5165\u6D88\u606F\uFF0CEnter\u53D1\u9001\uFF0CShift+Enter\u6362\u884C",style:{"border-style":"none"},type:"textarea",onKeyup:ce(me(e.handleSendMessage,["prevent"]),["enter"])},null,8,["modelValue","onKeyup"])]),_:1})]),_:1})):(c(),I(S,{key:1,class:"kefu"},{default:f(()=>[u(k,null,{default:f(()=>[u(p,{description:"\u8BF7\u9009\u62E9\u5DE6\u4FA7\u7684\u4E00\u4E2A\u4F1A\u8BDD\u540E\u5F00\u59CB"})]),_:1})]),_:1}))}],["__scopeId","data-v-174b9fab"],["__file","/Users/steven/00/500_code/520_github/yudao-ui-admin-vue3/src/views/mall/promotion/kefu/components/KeFuMessageList.vue"]]);export{Ae as default};
