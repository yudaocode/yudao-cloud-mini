import{d as W,S as X,D as Y,r as t,b as Z,C as ee,ao as E,_ as ae,o as g,q as w,w as c,k as l,j as C,m as z,t as F,c as H,ah as f,I as te,cb as ne,z as oe,N as se,b6 as le,e8 as ie,ch as re,eg as ve,b7 as ue}from"./index-BaY5TDP-.js";import{C as N}from"./index-CuG4_yhq.js";import{C as ce}from"./index-C2SngFyG.js";import de from"./ConversationList-BhDyY3KY.js";import me from"./ConversationUpdateForm-f3eRTlVk.js";import pe from"./MessageList-CnAiEYaC.js";import ge from"./MessageListEmpty-BL63NIdK.js";import Ce from"./MessageLoading-gZpA6Hi3.js";import he from"./MessageNewConversation-BNFM0doZ.js";import"./fetch-D5K_4anA.js";import"./el-drawer-r3cMvY4i.js";import"./el-empty-wTPt5q4m.js";import"./RoleRepository-BxJ_dL-w.js";import"./RoleHeader-DMeV7Zuv.js";import"./RoleList-CDc3DjHg.js";import"./ChatRoleForm-CkDSrpdx.js";import"./Dialog-CZSXtzfQ.js";import"./constants-CEEr2azc.js";import"./index-Cz_ljQ_t.js";import"./RoleCategoryList-C66gfOgI.js";import"./gpt-WhTktY3S.js";import"./el-avatar-DZsRbb7z.js";import"./formatTime-Dr6TiYYc.js";import"./index-BiCwg61_.js";import"./index-BuMQ6E3q.js";import"./avatar-BG6NdH5s.js";import"./el-skeleton-item-BYAIkmCs.js";const ye=W({name:"AiChat",__name:"index",setup($,{expose:i}){i();const I=X(),e=Y(),B=t(),n=t(null),u=t(null),o=t(!1),L=t(),s=t([]),S=t(!1),T=t(),p=t(50),r=t(!1),d=t(!1),h=t(),k=t(),y=t(),K=t(!0),M=t(""),b=t(""),O=async a=>{if(!a)return;const v=await ce.getChatConversationMy(a);v&&(u.value=v,n.value=v.id)},q=async()=>{if(o.value)return e.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1;n.value=null,u.value=null,s.value=[]},V=t(),D=async()=>{try{if(n.value===null)return;T.value=setTimeout(()=>{S.value=!0},60),s.value=await N.getChatMessageListByConversationId(n.value),await E(),await _()}finally{T.value&&clearTimeout(T.value),S.value=!1}},J=Z(()=>{var a;return s.value.length>0?s.value:(a=u.value)!=null&&a.systemMessage?[{id:0,type:"system",content:u.value.systemMessage}]:[]}),R=async a=>{a.length<1?e.error("\u53D1\u9001\u5931\u8D25\uFF0C\u539F\u56E0\uFF1A\u5185\u5BB9\u4E3A\u7A7A\uFF01"):n.value!=null?(y.value="",await j({conversationId:n.value,content:a})):e.error("\u8FD8\u6CA1\u521B\u5EFA\u5BF9\u8BDD\uFF0C\u4E0D\u80FD\u53D1\u9001!")},j=async a=>{h.value=new AbortController,o.value=!0,M.value="";try{s.value.push({id:-1,conversationId:n.value,type:"user",content:a.content,createTime:new Date}),s.value.push({id:-2,conversationId:n.value,type:"assistant",content:"\u601D\u8003\u4E2D...",createTime:new Date}),await E(),await _(),A();let v=!0;await N.sendChatMessageStream(a.conversationId,a.content,h.value,K.value,async m=>{const{code:x,data:U,msg:Q}=JSON.parse(m.data);x===0?U.receive.content!==""&&(v&&(v=!1,s.value.pop(),s.value.pop(),s.value.push(U.send),s.value.push(U.receive)),M.value=M.value+U.receive.content,await _()):e.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${Q}`)},m=>{e.alert(`\u5BF9\u8BDD\u5F02\u5E38! ${m}`),P()},()=>{P()})}catch{}},P=async()=>{h.value&&h.value.abort(),o.value=!1},_=async a=>{await E(),L.value&&L.value.scrollToBottom(a)},A=async()=>{let a=0;try{if(r.value)return;r.value=!0,b.value="";const v=async()=>{const x=(M.value.length-b.value.length)/10;p.value=x>5?10:x>2?30:x>1.5?50:100,o.value||(p.value=10),a<M.value.length?(b.value+=M.value[a],a++,s.value[s.value.length-1].content=b.value,await _(),m=setTimeout(v,p.value)):o.value?m=setTimeout(v,p.value):(r.value=!1,clearTimeout(m))};let m=setTimeout(v,p.value)}catch{}};ee(async()=>{if(I.query.conversationId){const a=I.query.conversationId;n.value=a,await O(a)}S.value=!0,await D()});const G={route:I,message:e,conversationListRef:B,activeConversationId:n,activeConversation:u,conversationInProgress:o,messageRef:L,activeMessageList:s,activeMessageListLoading:S,activeMessageListLoadingTimer:T,textSpeed:p,textRoleRunning:r,isComposing:d,conversationInAbortController:h,inputTimeout:k,prompt:y,enableContext:K,receiveMessageFullText:M,receiveMessageDisplayedText:b,getConversation:O,handleConversationClick:async a=>o.value?(e.alert("\u5BF9\u8BDD\u4E2D\uFF0C\u4E0D\u5141\u8BB8\u5207\u6362!"),!1):(n.value=a.id,u.value=a,await D(),_(!0),y.value="",!0),handlerConversationDelete:async a=>{n.value===a.id&&await q()},handleConversationClear:q,conversationUpdateFormRef:V,openChatConversationUpdateForm:async()=>{V.value.open(n.value)},handleConversationUpdateSuccess:async()=>{await O(n.value)},handleConversationCreate:async()=>{await B.value.createConversation()},handleConversationCreateSuccess:async()=>{y.value=""},getMessageList:D,messageList:J,handleMessageDelete:()=>{o.value?e.alert("\u56DE\u7B54\u4E2D\uFF0C\u4E0D\u80FD\u5220\u9664!"):D()},handlerMessageClear:async()=>{if(n.value)try{await e.delConfirm("\u786E\u8BA4\u6E05\u7A7A\u5BF9\u8BDD\u6D88\u606F\uFF1F"),await N.deleteByConversationId(n.value),s.value=[]}catch{}},handleGoTopMessage:()=>{L.value.handlerGoTop()},handleSendByKeydown:async a=>{var m;if(d.value||o.value)return;const v=(m=y.value)==null?void 0:m.trim();a.key==="Enter"&&(a.shiftKey?(y.value+=`\r
`,a.preventDefault()):(await R(v),a.preventDefault()))},handleSendByButton:()=>{var a;R((a=y.value)==null?void 0:a.trim())},handlePromptInput:a=>{if(!d.value){if(a.data==null)return;d.value=!0}k.value&&clearTimeout(k.value),k.value=setTimeout(()=>{d.value=!1},400)},onCompositionstart:()=>{d.value=!0},onCompositionend:()=>{setTimeout(()=>{d.value=!1},200)},doSendMessage:R,doSendMessageStream:j,stopStream:P,handleMessageEdit:a=>{y.value=a.content},handleMessageRefresh:a=>{R(a.content)},scrollToBottom:_,textRoll:A,ConversationList:de,ConversationUpdateForm:me,MessageList:pe,MessageListEmpty:ge,MessageLoading:Ce,MessageNewConversation:he};return Object.defineProperty(G,"__isScriptSetup",{enumerable:!1,value:!0}),G}}),fe={class:"title"},Me={key:0},we={key:0,class:"btns"},Le=["innerHTML"],Se={class:"message-container"},Te={class:"prompt-from"},_e={class:"prompt-btns"},be=ae(ye,[["render",function($,i,I,e,B,n){const u=oe,o=se,L=le,s=ie,S=re,T=ve,p=ue;return g(),w(p,{class:"ai-layout"},{default:c(()=>[l(e.ConversationList,{"active-id":e.activeConversationId,ref:"conversationListRef",onOnConversationCreate:e.handleConversationCreateSuccess,onOnConversationClick:e.handleConversationClick,onOnConversationClear:e.handleConversationClear,onOnConversationDelete:e.handlerConversationDelete},null,8,["active-id"]),l(p,{class:"detail-container"},{default:c(()=>[l(L,{class:"header"},{default:c(()=>{var r,d;return[C("div",fe,[z(F((r=e.activeConversation)!=null&&r.title?(d=e.activeConversation)==null?void 0:d.title:"\u5BF9\u8BDD")+" ",1),e.activeMessageList.length?(g(),H("span",Me,"("+F(e.activeMessageList.length)+")",1)):f("",!0)]),e.activeConversation?(g(),H("div",we,[l(o,{type:"primary",bg:"",plain:"",size:"small",onClick:e.openChatConversationUpdateForm},{default:c(()=>{var h;return[C("span",{innerHTML:(h=e.activeConversation)==null?void 0:h.modelName},null,8,Le),l(u,{icon:"ep:setting",class:"ml-10px"})]}),_:1}),l(o,{size:"small",class:"btn",onClick:e.handlerMessageClear},{default:c(()=>[l(u,{icon:"heroicons-outline:archive-box-x-mark",color:"#787878"})]),_:1}),l(o,{size:"small",class:"btn"},{default:c(()=>[l(u,{icon:"ep:download",color:"#787878"})]),_:1}),l(o,{size:"small",class:"btn",onClick:e.handleGoTopMessage},{default:c(()=>[l(u,{icon:"ep:top",color:"#787878"})]),_:1})])):f("",!0)]}),_:1}),l(s,{class:"main-container"},{default:c(()=>[C("div",null,[C("div",Se,[e.activeMessageListLoading?(g(),w(e.MessageLoading,{key:0})):f("",!0),e.activeConversation?f("",!0):(g(),w(e.MessageNewConversation,{key:1,onOnNewConversation:e.handleConversationCreate})),!e.activeMessageListLoading&&e.messageList.length===0&&e.activeConversation?(g(),w(e.MessageListEmpty,{key:2,onOnPrompt:e.doSendMessage})):f("",!0),!e.activeMessageListLoading&&e.messageList.length>0?(g(),w(e.MessageList,{key:3,ref:"messageRef",conversation:e.activeConversation,list:e.messageList,onOnDeleteSuccess:e.handleMessageDelete,onOnEdit:e.handleMessageEdit,onOnRefresh:e.handleMessageRefresh},null,8,["conversation","list"])):f("",!0)])])]),_:1}),l(T,{class:"footer-container"},{default:c(()=>[C("form",Te,[te(C("textarea",{class:"prompt-input","onUpdate:modelValue":i[0]||(i[0]=r=>e.prompt=r),onKeydown:e.handleSendByKeydown,onInput:e.handlePromptInput,onCompositionstart:e.onCompositionstart,onCompositionend:e.onCompositionend,placeholder:"\u95EE\u6211\u4EFB\u4F55\u95EE\u9898...\uFF08Shift+Enter \u6362\u884C\uFF0C\u6309\u4E0B Enter \u53D1\u9001\uFF09"},null,544),[[ne,e.prompt]]),C("div",_e,[C("div",null,[l(S,{modelValue:e.enableContext,"onUpdate:modelValue":i[1]||(i[1]=r=>e.enableContext=r)},null,8,["modelValue"]),i[3]||(i[3]=C("span",{class:"ml-5px text-14px text-#8f8f8f"},"\u4E0A\u4E0B\u6587",-1))]),e.conversationInProgress==0?(g(),w(o,{key:0,type:"primary",size:"default",onClick:e.handleSendByButton,loading:e.conversationInProgress},{default:c(()=>[z(F(e.conversationInProgress?"\u8FDB\u884C\u4E2D":"\u53D1\u9001"),1)]),_:1},8,["loading"])):f("",!0),e.conversationInProgress==1?(g(),w(o,{key:1,type:"danger",size:"default",onClick:i[2]||(i[2]=r=>e.stopStream())},{default:c(()=>i[4]||(i[4]=[z(" \u505C\u6B62 ")])),_:1})):f("",!0)])])]),_:1})]),_:1}),l(e.ConversationUpdateForm,{ref:"conversationUpdateFormRef",onSuccess:e.handleConversationUpdateSuccess},null,512)]),_:1})}],["__scopeId","data-v-b0a10e91"],["__file","/Users/steven/00/500_code/520_github/yudao-ui-admin-vue3/src/views/ai/chat/index/index.vue"]]);export{be as default};
